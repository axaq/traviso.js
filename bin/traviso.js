/**
 * @license
 * traviso.js - v0.0.9
 * Copyright (c) 2015, Hakan Karlidag - @axaq
 * www.travisojs.com
 *
 * Compiled: 2018-02-02
 *
 * traviso.js is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license.php
 */
(function(){var a=a||{};a.VERSION="v0.0.9",a.pfAlgorithms={ASTAR_ORTHOGONAL:0,ASTAR_DIAGONAL:1},a.config={logEnabled:!1},a.trace=function(b){a.config.logEnabled&&console.log("TRAVISO: "+b)},a.getEngineInstance=function(b,c){return a.init(c),new a.EngineView(b)},a.init=function(b){if(b&&(a.config.logEnabled=b.logEnabled),!a.isReady){for(var c=["instantCameraZoom","followCharacter","instantCameraRelocation","instantObjectRelocation","changeTransperancies","highlightPath","highlightTargetTile","tileHighlightAnimated","dontAutoMoveToTile","checkPathOnEachTile","mapDraggable","engineInstanceReadyCallback","tileSelectCallback","objectSelectCallback","objectReachedDestinationCallback","otherObjectsOnTheNextTileCallback","objectUpdateCallback"],d=0;d<c.length;d++)a.defineProperty(c[d]);a.directions={O:0,S:1,SW:2,W:3,NW:4,N:5,NE:6,E:7,SE:8},a.RESERVED_TEXTURE_IDS=["idle","idle_s","idle_sw","idle_w","idle_nw","idle_n","idle_ne","idle_e","idle_se","move_s","move_sw","move_w","move_nw","move_n","move_ne","move_e","move_se"],a.isReady=!0,a.trace("Traviso initiated")}},a.defineProperty=function(b){Object.defineProperty(a.EngineView.prototype,b,{get:function(){return this.config[b]},set:function(a){this.config[b]=a}})},a.loadAssetsAndData=function(b,c){if(!b.config.mapDataPath)throw new Error("TRAVISO: No JSON-file path defined for map data. Plese check your configuration object that you pass to the 'getEngineInstance' method.");if("json"!==b.config.mapDataPath.split(".").pop())throw new Error("TRAVISO: Invalid map-data file path. This file has to be a json file.");var d=new PIXI.loaders.Loader;d.add("mapData",b.config.mapDataPath),b.config.assetsToLoad&&""!==b.config.assetsToLoad&&b.config.assetsToLoad.length>0&&d.add(b.config.assetsToLoad),d.load(function(d,e){a.assetsAndDataLoaded(b,c,e)})},a.assetsAndDataLoaded=function(b,c,d){var e=d.mapData.data;a.existy(e.initialControllableLocation)?a.existy(e.initialControllableLocation.columnIndex)&&a.existy(e.initialControllableLocation.rowIndex)||(a.trace("Map-data file warning: 'initialControllableLocation' exists but it is not defined properly."),e.initialControllableLocation=null):a.trace("Map-data file warning: No 'initialControllableLocation' defined. Ignore this warning if you are adding it later manually."),e.tileHighlightImage&&!e.tileHighlightImage.path&&(a.trace("Map-data file warning: 'tileHighlightImage' exists but its 'path' is not defined properly."),e.tileHighlightImage=null),e.singleGroundImage&&!e.singleGroundImage.path&&(a.trace("Map-data file warning: 'singleGroundImage' exists but its 'path' is not defined properly."),e.singleGroundImage=null);var f,g,h,i=e.groundMap;for(e.groundMapData=[],f=0;f<i.length;f++){for(h=String(i[f].row).split(","),g=h.length;g--;)h[g]=0|h[g];e.groundMapData[f]=h}for(i=e.objectsMap,e.objectsMapData=[],f=0;f<i.length;f++){for(h=String(i[f].row).split(","),g=h.length;g--;)h[g]=0|h[g];e.objectsMapData[f]=h}a.existy(e.tiles)||(a.trace("Map-data file warning: No 'tiles' defined."),e.tiles={}),a.existy(e.objects)||(a.trace("Map-data file warning: No 'objects' defined."),e.objects={});var j,k,l,m,n,o,p,q;for(k in e.objects){if(j=e.objects[k],!a.existy(j.visuals))throw new Error("TRAVISO: No visuals defined in data-file for object type: "+k);j.id=k,a.existy(j.rowSpan)||(j.rowSpan=1),a.existy(j.columnSpan)||(j.columnSpan=1),o={},n={};for(m in j.visuals)if(l=j.visuals[m],a.existy(l.ipor)&&a.existy(l.ipoc)&&(n[m]={c:parseInt(l.ipoc),r:parseInt(l.ipor)}),l.frames&&l.frames.length>0)for(o[m]=[],p=0;p<l.frames.length;p++)o[m][p]=l.frames[p].path;else{if(!l.path||!l.extension||!l.numberOfFrames||l.numberOfFrames<1)throw new Error("TRAVISO: Invalid or missing visual attributes detected in data-file for visual with id: "+m);if(o[m]=[],1===l.numberOfFrames)o[m][0]=l.path+"."+l.extension;else for(q=0,p=l.startIndex;p<l.numberOfFrames;p++)o[m][q++]=l.path+String(p)+"."+l.extension}j.t=o,j.io=n,j.f=!!j.floor,j.nt=!!j.noTransparency,j.m=!!j.movable,j.i=!!j.interactive}delete e.objectsMap,delete e.groundMap,b.mapData=e,c&&c()},a.getObjectInfo=function(b,c){var d=b.mapData.objects[c];if(d){var e={};for(var f in d.t)e[f]=a.getObjectTextures(b,c,f);return{m:d.m,i:d.i,f:d.f,nt:d.nt,t:e,io:d.io,s:d.s,rowSpan:d.rowSpan,columnSpan:d.columnSpan}}throw new Error("TRAVISO: No info defined for object type: "+c)},a.getObjectTextures=function(b,c,d){var e=b.mapData.objects[c];if(e){var f=null,g=e.t[d];if(g){f=[];for(var h=0;h<g.length;h++)f[f.length]=PIXI.Texture.fromFrame(g[h])}else a.trace("No textures defined for object type: "+c+" and visualId: "+d);return f}throw new Error("TRAVISO: No info defined for object type: "+c)},a.getTileInfo=function(a,b){var c=a.mapData.tiles[b];if(c)return{m:c.movable,t:c.path?[PIXI.Texture.fromFrame(c.path)]:[]};if(a.mapData.singleGroundImage)return{m:parseInt(b)>0?1:0,t:[]};throw new Error("TRAVISO: No info defined for tile type: "+b)},a.getStationaryDirVisualId=function(b){return a.RESERVED_TEXTURE_IDS[b]},a.getMovingDirVisualId=function(b){return a.RESERVED_TEXTURE_IDS[b+8]},a.getDirBetween=function(b,c,d,e){var f=a.directions.S;return b===d?f=c===e?a.directions.O:e>c?a.directions.NE:a.directions.SW:d>b?f=c===e?a.directions.SE:e>c?a.directions.W:a.directions.S:b>d&&(f=c===e?a.directions.NW:e>c?a.directions.N:a.directions.E),f},a.mathMap=function(a,b,c,d,e,f){if(f){if(b>a)return d;if(a>c)return e}return d+(e-d)*(a-b)/(c-b)},a.dotProduct=function(a,b){return a.x*b.x+a.y*b.y},a.getUnit=function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y);return{x:a.x/b,y:a.y/b}},a.isInPolygon=function(a,b){var c,d,e=a.y,f=a.x,g=b.length,h=!1;for(c=0,d=g-1;g>c;d=c++)b[c][1]>e!=b[d][1]>e&&f<(b[d][0]-b[c][0])*(e-b[c][1])/(b[d][1]-b[c][1])+b[c][0]&&(h=!h);return h},a.getDist=function(a,b){return Math.sqrt((b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y))},a.localToGlobal=function(a,b){for(var c=b.position.x+a.x,d=b.position.y+a.y,e=b.parent;e;)c+=e.position.x,d+=e.position.y,e=e.parent;return{x:c,y:d}},a.globalToLocal=function(a,b){for(var c=b.position.x,d=b.position.y,e=b.parent;e;)c+=e.position.x,d+=e.position.y,e=e.parent;return{x:a.x-c,y:a.y-d}},a.existy=function(a){return null!==a&&void 0!==a},a.MoveEngine=function(a,b){this.engine=a,this.DEFAULT_SPEED=b||3,this.activeForMovables=!1,this.activeForTweens=!1,this.processFrame=!0,this.movables=[],this.tweenTargets=[],this.fps=60,this.processFunc=this.run.bind(this),this.ticker=new PIXI.ticker.Ticker,this.ticker.add(this.processFunc),this.ticker.start()},a.MoveEngine.constructor=a.MoveEngine,a.MoveEngine.prototype.addTween=function(a,b,c,d,e,f,g){var h=null;for(var i in c)a[i]!==c[i]&&(h||(h={}),h[i]={b:a[i],c:c[i]-a[i]});if(h){var j={target:a,duration:b,delay:Number(d)||0,easingFunc:this.getEasingFunc(e),overwrite:f||!1,onComplete:g||null,totalFrames:b*this.fps,currentFrame:0,vars:h},k=this.tweenTargets.indexOf(a);if(k>=0){var l=a.tweens;if(l||(l=[]),j.overwrite){for(var m=0;m<l.length;m++)l[m]=null;l=[]}l[l.length]=j,a.tweens=l}else a.tweens=[j],this.tweenTargets[this.tweenTargets.length]=a;this.tweenTargets.length>0&&!this.activeForTweens&&(this.activeForTweens=!0)}},a.MoveEngine.prototype.removeTween=function(a,b){var c=!1;if(a&&b){var d=this.tweenTargets.indexOf(a);if(!(d>=0))throw new Error("No tween target defined for this object");if(!(this.tweenTargets[d].tweens&&this.tweenTargets[d].tweens.length>0))throw new Error("No tween defined for this object");var e=this.tweenTargets[d].tweens,f=e.indexOf(b);if(!(f>=0))throw new Error("No tween defined for this object");b.onComplete=null,b.easingFunc=null,b.target=null,e.splice(f,1),0===e.length&&(this.tweenTargets.splice(d,1),c=!0),0===this.tweenTargets.length&&(this.activeForTweens=!1)}return c},a.MoveEngine.prototype.killTweensOf=function(a){var b=!1,c=this.tweenTargets.indexOf(a);if(c>=0){if(this.tweenTargets[c].tweens&&this.tweenTargets[c].tweens.length>0){for(var d=this.tweenTargets[c].tweens,e=0;e<d.length;e++)d[e].onComplete=null,d[e].easingFunc=null,d[e].target=null,d[e]=null;this.tweenTargets[c].tweens=null}this.tweenTargets.splice(c,1),b=!0}return 0===this.tweenTargets.length&&(this.activeForTweens=!1),b},a.MoveEngine.prototype.removeAllTweens=function(){this.activeForTweens=!1;var a,b,c,d=this.tweenTargets.length;for(b=0;d>b;b++){for(a=this.tweenTargets[b].tweens,c=0;c<a.length;c++)a[c].onComplete=null,a[c].easingFunc=null,a[c].target=null,a[c]=null;this.tweenTargets[b].tweens=null,this.tweenTargets[b]=null}this.tweenTargets=[]},a.MoveEngine.prototype.addMovable=function(a){this.movables.indexOf(a)>=0||(this.movables[this.movables.length]=a,this.movables.length>0&&!this.activeForMovables&&(this.activeForMovables=!0))},a.MoveEngine.prototype.removeMovable=function(a){var b=this.movables.indexOf(a);return-1!==b&&(a.speedUnit={x:0,y:0},this.movables.splice(b,1)),0===this.movables.length&&(this.activeForMovables=!1),-1!==b},a.MoveEngine.prototype.removeAllMovables=function(){this.activeForMovables=!1;for(var a=this.movables.length,b=0;a>b;b++)this.movables[b]=null;this.movables=[]},a.MoveEngine.prototype.addNewPathToObject=function(a,b,c){a.currentPath&&a.currentTarget&&(b[b.length]=a.currentPath[a.currentPathStep]),a.currentPath=b,a.currentPathStep=a.currentPath.length-1,a.speedMagnitude=c||a.speedMagnitude||this.DEFAULT_SPEED},a.MoveEngine.prototype.prepareForMove=function(a,b,c){a.currentPath=b,a.currentPathStep=a.currentPath.length-1,a.speedMagnitude=c||a.speedMagnitude||this.DEFAULT_SPEED},a.MoveEngine.prototype.setMoveParameters=function(b,c){var d=this.engine.getTilePosXFor(c.r,c.c),e=this.engine.getTilePosYFor(c.r,c.c)+this.engine.TILE_HALF_H;b.speedUnit=a.getUnit({x:d-b.position.x,y:e-b.position.y}),b.currentTarget={x:d,y:e},b.currentReachThresh=Math.ceil(Math.sqrt(b.speedUnit.x*b.speedUnit.x+b.speedUnit.y*b.speedUnit.y)*b.speedMagnitude)},a.MoveEngine.prototype.getEasingFunc=function(a){return"easeInOut"===a||"easeInOutQuad"===a||"Quad.easeInOut"===a?this.easeInOutQuad:"easeIn"===a||"easeInQuad"===a||"Quad.easeIn"===a?this.easeInQuad:"easeOut"===a||"easeOutQuad"===a||"Quad.easeOut"===a?this.easeOutQuad:this.linearTween},a.MoveEngine.prototype.linearTween=function(a,b,c,d){return c*a/d+b},a.MoveEngine.prototype.easeInQuad=function(a,b,c,d){return a/=d,c*a*a+b},a.MoveEngine.prototype.easeOutQuad=function(a,b,c,d){return a/=d,-c*a*(a-2)+b},a.MoveEngine.prototype.easeInOutQuad=function(a,b,c,d){return a/=d/2,1>a?c/2*a*a+b:(a--,-c/2*(a*(a-2)-1)+b)},a.MoveEngine.prototype.run=function(){if(this.processFrame){var b,c,d;if(this.activeForMovables){b=this.movables.length;var e;for(d=0;b>d;d++)c=this.movables[d],c.prevPosition={x:c.position.x,y:c.position.y},c.currentTarget&&(e=a.getDist(c.position,c.currentTarget),e<=c.currentReachThresh)?(c.position.x=c.currentTarget.x,c.position.y=c.currentTarget.y,this.engine.onObjMoveStepEnd(c),d--,b--):(c.position.x+=c.speedMagnitude*c.speedUnit.x,c.position.y+=c.speedMagnitude*c.speedUnit.y,this.engine.checkForTileChange(c),this.engine.checkForFollowCharacter(c))}if(this.activeForTweens){b=this.tweenTargets.length;var f,g,h,i;for(d=0;b>d;d++)for(c=this.tweenTargets[d],g=c.tweens,h=0;h<g.length;h++){f=g[h],f.currentFrame++,i=f.vars;for(var j in i)c[j]=f.easingFunc(f.currentFrame,i[j].b,i[j].c,f.totalFrames);f.currentFrame>=f.totalFrames&&(f.onComplete&&f.onComplete(),this.removeTween(c,f)&&(d--,b--),h--)}}}},a.MoveEngine.prototype.destroy=function(){a.trace("MoveEngine destroy"),this.processFrame=!1,this.ticker&&this.ticker.stop(),this.removeAllMovables(),this.removeAllTweens(),this.movables=null,this.tweenTargets=null,this.engine=null,this.ticker=null},a.PathFinding=function(b,c,d){var e=0,f=0;for(d=d||{},this.nodes=[],this.diagonal=!!d.diagonal,this.heuristic=this.diagonal?this.heuristics.diagonal:this.heuristics.manhattan,this.closest=!!d.closest,this.grid=[],e=0;b>e;e++)for(this.grid[e]=[],f=0;c>f;f++){var g=new a.PathFinding.GridNode(e,f,1);this.grid[e][f]=g,this.nodes.push(g)}this.init()},a.PathFinding.constructor=a.PathFinding,a.PathFinding.prototype.init=function(){this.dirtyNodes=[];for(var a=0;a<this.nodes.length;a++)this.cleanNode(this.nodes[a])},a.PathFinding.prototype.cleanDirty=function(){for(var a=0;a<this.dirtyNodes.length;a++)this.cleanNode(this.dirtyNodes[a]);this.dirtyNodes=[]},a.PathFinding.prototype.markDirty=function(a){this.dirtyNodes.push(a)},a.PathFinding.prototype.neighbors=function(a){var b=[],c=a.x,d=a.y,e=this.grid;return e[c-1]&&e[c-1][d]&&b.push(e[c-1][d]),e[c+1]&&e[c+1][d]&&b.push(e[c+1][d]),e[c]&&e[c][d-1]&&b.push(e[c][d-1]),e[c]&&e[c][d+1]&&b.push(e[c][d+1]),this.diagonal&&(e[c-1]&&e[c-1][d-1]&&b.push(e[c-1][d-1]),e[c+1]&&e[c+1][d-1]&&b.push(e[c+1][d-1]),e[c-1]&&e[c-1][d+1]&&b.push(e[c-1][d+1]),e[c+1]&&e[c+1][d+1]&&b.push(e[c+1][d+1])),b},a.PathFinding.prototype.toString=function(){for(var a,b,c,d,e=[],f=this.grid,g=0,h=f.length;h>g;g++){for(a=[],b=f[g],c=0,d=b.length;d>c;c++)a.push(b[c].weight);e.push(a.join(" "))}return e.join("\n")},a.PathFinding.GridNode=function(a,b,c){this.x=a,this.y=b,this.weight=c,this.mapPos={c:a,r:b}},a.PathFinding.GridNode.constructor=a.PathFinding.GridNode,a.PathFinding.GridNode.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},a.PathFinding.GridNode.prototype.getCost=function(a){return a&&a.x!==this.x&&a.y!==this.y?1.41421*this.weight:this.weight},a.PathFinding.GridNode.prototype.isWall=function(){return 0===this.weight},a.PathFinding.prototype.solve=function(a,b,c,d){var e=this.grid[a][b],f=this.grid[c][d],g=this.search(e,f,{heuristic:this.heuristic,closest:this.closest});return g&&g.length>0?g:null},a.PathFinding.prototype.getAdjacentOpenCells=function(a,b,c,d){var e,f,g=[];for(e=b;e>b-d;e--)for(f=a;a+c>f;f++)g=g.concat(this.neighbors(this.grid[f][e]));return g},a.PathFinding.prototype.pathTo=function(a){for(var b=a,c=[];b.parent;)c.push(b),b=b.parent;return c},a.PathFinding.prototype.getHeap=function(){return new a.PathFinding.BinaryHeap(function(a){return a.f})},a.PathFinding.prototype.search=function(a,b,c){this.init(),c=c||{};var d=c.heuristic||this.heuristics.manhattan,e=c.closest||!1,f=this.getHeap(),g=a;for(a.h=d(a,b),f.push(a);f.size()>0;){var h=f.pop();if(h===b)return this.pathTo(h);h.closed=!0;for(var i=this.neighbors(h),j=0,k=i.length;k>j;++j){var l=i[j];if(!l.closed&&!l.isWall()){var m=h.g+l.getCost(h),n=l.visited;(!n||m<l.g)&&(l.visited=!0,l.parent=h,l.h=l.h||d(l,b),l.g=m,l.f=l.g+l.h,this.markDirty(l),e&&(l.h<g.h||l.h===g.h&&l.g<g.g)&&(g=l),n?f.rescoreElement(l):f.push(l))}}}return e?this.pathTo(g):[]},a.PathFinding.prototype.heuristics={manhattan:function(a,b){var c=Math.abs(b.x-a.x),d=Math.abs(b.y-a.y);return c+d},diagonal:function(a,b){var c=1,d=Math.sqrt(2),e=Math.abs(b.x-a.x),f=Math.abs(b.y-a.y);return c*(e+f)+(d-2*c)*Math.min(e,f)}},a.PathFinding.prototype.cleanNode=function(a){a.f=0,a.g=0,a.h=0,a.visited=!1,a.closed=!1,a.parent=null},a.PathFinding.BinaryHeap=function(a){this.content=[],this.scoreFunction=a},a.PathFinding.BinaryHeap.prototype={push:function(a){this.content.push(a),this.sinkDown(this.content.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.bubbleUp(0)),a},remove:function(a){var b=this.content.indexOf(a),c=this.content.pop();b!==this.content.length-1&&(this.content[b]=c,this.scoreFunction(c)<this.scoreFunction(a)?this.sinkDown(b):this.bubbleUp(b))},size:function(){return this.content.length},rescoreElement:function(a){this.sinkDown(this.content.indexOf(a))},sinkDown:function(a){for(var b=this.content[a];a>0;){var c=(a+1>>1)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},bubbleUp:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e,f=a+1<<1,g=f-1,h=null;if(b>g){var i=this.content[g];e=this.scoreFunction(i),d>e&&(h=g)}if(b>f){var j=this.content[f],k=this.scoreFunction(j);(null===h?d:e)>k&&(h=f)}if(null===h)break;this.content[a]=this.content[h],this.content[h]=c,a=h}}},a.PathFinding.prototype.isCellFilled=function(a,b){return 0===this.grid[a][b].weight?!0:!1},a.PathFinding.prototype.setCell=function(a,b,c){this.grid[a][b].staticWeight=this.grid[a][b].weight=c},a.PathFinding.prototype.setDynamicCell=function(a,b,c){0!==this.grid[a][b].staticWeight&&(this.grid[a][b].weight=c)},a.PathFinding.prototype.destroy=function(){a.trace("PathFinding destroy"),this.grid=null,this.nodes=null,this.dirtyNodes=null,this.heuristic=null},a.ObjectView=function(b,c,d){PIXI.Container.call(this),this.engine=b,this.type=c||0;var e=a.getObjectInfo(this.engine,this.type);this.isMovableTo=e.m,this.isInteractive=e.i,this.interactive=this.interactiveChildren=!1,this.isFloorObject=e.f,this.noTransparency=e.nt,this.rowSpan=e.rowSpan,this.columnSpan=e.columnSpan;var f=this.rowSpan/(this.columnSpan+this.rowSpan);this.textures=e.t,this.interactionOffsets=e.io,this.currentInteractionOffset=this.interactionOffsets.idle,this.container=new PIXI.extras.AnimatedSprite(this.textures.idle),this.container.interactive=this.container.interactiveChildren=!1,this.container.anchor.x=f,this.container.anchor.y=1,this.addChild(this.container),this.animSpeed=d,this.container.gotoAndStop(0),this.firstTextureHeight=this.container.textures[0].height},a.ObjectView.constructor=a.ObjectView,a.ObjectView.prototype=Object.create(PIXI.Container.prototype),Object.defineProperty(a.ObjectView.prototype,"animSpeed",{get:function(){return this.container.animationSpeed},set:function(b){this.container.animationSpeed=a.existy(b)&&b>0?b:.5}}),a.ObjectView.prototype.changeVisualToDirection=function(b,c,d,e,f,g){if(this.changeVisual(c?a.getMovingDirVisualId(b):a.getStationaryDirVisualId(b),d,e,f,g))this.currentDirection=b;else{if(!this.changeVisual("idle",d,e,f,g))throw new Error("no 'idle' visual defined as backup for object type "+this.type);this.currentDirection=a.directions.O}},a.ObjectView.prototype.changeVisual=function(b,c,d,e,f){if(!this.textures[b])return!1;if(this.currentInteractionOffset=this.interactionOffsets[b],this.container.textures===this.textures[b]&&!d)return this.container.loop=!d,a.existy(f)&&f>0&&(this.animSpeed=f),!0;if(this.container.textures=this.textures[b],!c&&this.textures[b].length>1){if(this.container.loop=!d,d&&e){var g=this;this.container.onComplete=function(){setTimeout(function(){e(g)},100)}}a.existy(f)&&f>0&&(this.animSpeed=f),this.container.gotoAndPlay(0)}else this.container.gotoAndStop(0);return this.engine.config.objectUpdateCallback&&this.engine.config.objectUpdateCallback(this),!0},a.ObjectView.prototype.destroy=function(){this.container&&(this.engine=null,this.textures=null,this.container.onComplete=null,this.container=null)},a.TileView=function(b,c){PIXI.Container.call(this),this.engine=b,this.type=c||"0";var d=this.engine.TILE_HALF_H,e=this.engine.TILE_HALF_W;this.vertices=[[-e,0],[0,-d],[e,0],[0,d]];var f=a.getTileInfo(this.engine,this.type);if(this.isMovableTo=f.m,f.t.length>0&&(this.tileGraphics=new PIXI.extras.AnimatedSprite(f.t),this.tileGraphics.anchor.x=.5,this.tileGraphics.anchor.y=.5,this.addChild(this.tileGraphics),this.tileGraphics.gotoAndStop(this.type)),this.engine.mapData.tileHighlightImage)this.highlightedOverlay=new PIXI.Sprite.fromFrame(this.engine.mapData.tileHighlightImage.path),this.highlightedOverlay.anchor.x=.5,this.highlightedOverlay.anchor.y=.5,this.addChild(this.highlightedOverlay);else{this.highlightedOverlay=new PIXI.Graphics,this.highlightedOverlay.clear(),this.highlightedOverlay.lineStyle(this.engine.config.tileHighlightStrokeAlpha<=0?0:2,this.engine.config.tileHighlightStrokeColor,this.engine.config.tileHighlightStrokeAlpha),this.highlightedOverlay.beginFill(this.engine.config.tileHighlightFillColor,this.engine.config.tileHighlightFillAlpha),this.highlightedOverlay.moveTo(this.vertices[0][0],this.vertices[0][1]);for(var g=1;g<this.vertices.length;g++)this.highlightedOverlay.lineTo(this.vertices[g][0],this.vertices[g][1]);this.highlightedOverlay.lineTo(this.vertices[0][0],this.vertices[0][1]),this.highlightedOverlay.endFill(),this.addChild(this.highlightedOverlay)}this.highlightedOverlay.scale.x=this.highlightedOverlay.scale.y=.1,this.highlightedOverlay.visible=!1,this.highlightedOverlay.scale.tweenScope=this.highlightedOverlay,this.highlightedOverlay.scale.isHighlighted=this.isHighlighted=!1},a.TileView.constructor=a.TileView,a.TileView.prototype=Object.create(PIXI.Container.prototype),a.TileView.prototype.setHighlighted=function(a,b){if(this.isHighlighted!==a){if(b)return this.highlightedOverlay.scale.x=this.highlightedOverlay.scale.y=a?1:.1,this.highlightedOverlay.visible=a,void(this.highlightedOverlay.scale.isHighlighted=this.isHighlighted=a);a&&(this.highlightedOverlay.visible=a),this.highlightedOverlay.scale.isHighlighted=this.isHighlighted=a;var c=a?1:.1;this.highlightedOverlay.scale.x===c?this.highlightedOverlay.visible=a:(this.highlightedOverlay.scale.x=this.highlightedOverlay.scale.y=a?.1:1,this.engine.moveEngine.addTween(this.highlightedOverlay.scale,.5,{x:c,y:c},0,"linear",!0,function(){this.target.tweenScope.visible=this.target.isHighlighted}))}},a.TileView.prototype.destroy=function(){this.engine&&(this.engine&&this.engine.moveEngine&&this.engine.moveEngine.killTweensOf(this.highlightedOverlay.scale),this.engine=null,this.highlightedOverlay.scale.tweenScope=null,this.highlightedOverlay=null,this.tileGraphics=null)},a.EngineView=function(b){PIXI.Container.call(this),this.config=b||{},this.config.followCharacter=a.existy(this.config.followCharacter)?this.config.followCharacter:!0,this.config.changeTransperancies=a.existy(this.config.changeTransperancies)?this.config.changeTransperancies:!0,this.config.highlightPath=a.existy(this.config.highlightPath)?this.config.highlightPath:!0,this.config.highlightTargetTile=a.existy(this.config.highlightTargetTile)?this.config.highlightTargetTile:!0,this.config.tileHighlightAnimated=a.existy(this.config.tileHighlightAnimated)?this.config.tileHighlightAnimated:!0,this.config.tileHighlightFillColor=a.existy(this.config.tileHighlightFillColor)?this.config.tileHighlightFillColor:8443903,this.config.tileHighlightFillAlpha=a.existy(this.config.tileHighlightFillAlpha)?this.config.tileHighlightFillAlpha:.5,this.config.tileHighlightStrokeColor=a.existy(this.config.tileHighlightStrokeColor)?this.config.tileHighlightStrokeColor:16777215,this.config.tileHighlightStrokeAlpha=a.existy(this.config.tileHighlightStrokeAlpha)?this.config.tileHighlightStrokeAlpha:1,this.config.dontAutoMoveToTile=a.existy(this.config.dontAutoMoveToTile)?this.config.dontAutoMoveToTile:!1,this.config.checkPathOnEachTile=a.existy(this.config.checkPathOnEachTile)?this.config.checkPathOnEachTile:!0,this.config.mapDraggable=a.existy(this.config.mapDraggable)?this.config.mapDraggable:!0,this.setZoomParameters(this.config.minScale,this.config.maxScale,this.config.numberOfZoomLevels,this.config.initialZoomLevel,this.config.instantCameraZoom),this.TILE_H=this.config.tileHeight||74,this.ISO_ANGLE=this.config.isoAngle||30,this.TILE_HALF_H=this.TILE_H/2,this.TILE_HALF_W=this.TILE_HALF_H*Math.tan((90-this.ISO_ANGLE)*Math.PI/180),this.TILE_W=2*this.TILE_HALF_W,this.TILE_ISO_EDGE_L=this.TILE_H,a.loadAssetsAndData(this,this.onAllAssetsLoaded.bind(this))},a.EngineView.constructor=a.EngineView,a.EngineView.prototype=Object.create(PIXI.Container.prototype),a.EngineView.prototype.config=this.config,a.EngineView.prototype.onAllAssetsLoaded=function(){a.trace("onAllAssetsLoaded"),this.moveEngine=new a.MoveEngine(this),this.currentScale=1,this.currentZoom=0,this.posFrame=this.config.initialPositionFrame||{x:0,y:0,w:800,h:600},this.externalCenter={x:this.posFrame.w>>1,y:this.posFrame.h>>1},this.createMap(),this.repositionContent(this.config.initialPositionFrame),this.enableInteraction(),this.config.engineInstanceReadyCallback&&this.config.engineInstanceReadyCallback(this)},a.EngineView.prototype.createMap=function(){this.config.backgroundColor&&(this.bg=new PIXI.Graphics,this.addChild(this.bg)),this.config.useMask&&(this.mapMask=new PIXI.Graphics,this.addChild(this.mapMask)),this.mapContainer=new PIXI.Container,this.addChild(this.mapContainer),this.groundContainer=new PIXI.Container,this.mapContainer.addChild(this.groundContainer),this.objContainer=new PIXI.Container,this.mapContainer.addChild(this.objContainer);var b=this.mapData.groundMapData,c=this.mapData.objectsMapData,d=this.mapData.initialControllableLocation;this.mapSizeR=b.length,this.mapSizeC=b[0].length;var e;this.mapData.singleGroundImage&&(e=new PIXI.Sprite.fromFrame(this.mapData.singleGroundImage.path),this.groundContainer.addChild(e),e.scale.set(this.mapData.singleGroundImage.scale||1),this.groundImageSprite=e),this.tileArray=[],this.objArray=[];var f,g;for(f=0;f<this.mapSizeR;f++)for(this.tileArray[f]=[],this.objArray[f]=[],g=0;g<this.mapSizeC;g++)this.tileArray[f][g]=null,this.objArray[f][g]=null;this.pathFinding=new a.PathFinding(this.mapSizeC,this.mapSizeR,{diagonal:this.config.pathFindingType===a.pfAlgorithms.ASTAR_DIAGONAL,closest:this.config.pathFindingClosest});var h;for(f=0;f<this.mapSizeR;f++)for(g=this.mapSizeC-1;g>=0;g--)this.tileArray[f][g]=null,b[f][g]?(h=new a.TileView(this,b[f][g]),h.position.x=this.getTilePosXFor(f,g),h.position.y=this.getTilePosYFor(f,g),h.mapPos={c:g,r:f},this.tileArray[f][g]=h,this.groundContainer.addChild(h),h.isMovableTo||this.pathFinding.setCell(g,f,0)):this.pathFinding.setCell(g,f,0);var i,j=!1;for(f=0;f<this.mapSizeR;f++)for(g=this.mapSizeC-1;g>=0;g--)this.objArray[f][g]=null,c[f][g]&&(i=new a.ObjectView(this,c[f][g]),i.position.x=this.getTilePosXFor(f,g),i.position.y=this.getTilePosYFor(f,g)+this.TILE_HALF_H,i.mapPos={c:g,r:f},!j&&i.isFloorObject&&(j=!0),this.objContainer.addChild(i),this.addObjRefToLocation(i,i.mapPos),d&&d.columnIndex===g&&d.rowIndex===f&&(this.currentControllable=i));if(j){var k,l;for(f=0;f<this.mapSizeR;f++)for(g=this.mapSizeC-1;g>=0;g--)if(k=this.objArray[f][g])for(l=0;l<k.length;l++)k[l].isFloorObject||this.objContainer.addChild(k[l])}this.mapVertices=[[this.getTilePosXFor(0,0)-this.TILE_HALF_W,this.getTilePosYFor(0,0)],[this.getTilePosXFor(0,this.mapSizeC-1),this.getTilePosYFor(0,this.mapSizeC-1)-this.TILE_HALF_H],[this.getTilePosXFor(this.mapSizeR-1,this.mapSizeC-1)+this.TILE_HALF_W,this.getTilePosYFor(this.mapSizeR-1,this.mapSizeC-1)],[this.getTilePosXFor(this.mapSizeR-1,0),this.getTilePosYFor(this.mapSizeR-1,0)+this.TILE_HALF_H]],this.mapVisualWidthReal=this.getTilePosXFor(this.mapSizeR-1,this.mapSizeC-1)-this.getTilePosXFor(0,0),this.mapVisualHeightReal=this.getTilePosYFor(this.mapSizeR-1,0)-this.getTilePosYFor(0,this.mapSizeC-1),e&&(e.position.x=this.mapVertices[0][0]+this.TILE_HALF_W+(this.mapVisualWidthReal-e.width)/2,e.position.y=this.mapVertices[1][1]+this.TILE_HALF_H+(this.mapVisualHeightReal-e.height)/2),this.zoomTo(this.config.initialZoomLevel,!0),this.config.followCharacter&&d?this.centralizeToLocation(d.columnIndex,d.rowIndex,!0):this.centralizeToCurrentExternalCenter(!0)},a.EngineView.prototype.getTilePosXFor=function(a,b){return b*this.TILE_HALF_W+a*this.TILE_HALF_W},a.EngineView.prototype.getTilePosYFor=function(a,b){return a*this.TILE_HALF_H-b*this.TILE_HALF_H},a.EngineView.prototype.showHideObjectLayer=function(a){this.objContainer.visible=a},a.EngineView.prototype.showHideGroundLayer=function(a){this.groundContainer.visible=a},a.EngineView.prototype.getTileAtRowAndColumn=function(a,b){return this.tileArray[a][b]},a.EngineView.prototype.getObjectsAtRowAndColumn=function(a,b){return this.objArray[a][b]},a.EngineView.prototype.getObjectsAtLocation=function(a){return this.objArray[a.r][a.c]},a.EngineView.prototype.createAndAddObjectToLocation=function(b,c){return this.addObjectToLocation(new a.ObjectView(this,b),c)},a.EngineView.prototype.addObjectToLocation=function(a,b){return a.position.x=this.getTilePosXFor(b.r,b.c),a.position.y=this.getTilePosYFor(b.r,b.c)+this.TILE_HALF_H,a.mapPos={c:b.c,r:b.r},this.objContainer.addChild(a),this.addObjRefToLocation(a,a.mapPos),this.arrangeDepthsFromLocation(a.isFloorObject?{c:this.mapSizeC-1,r:0}:a.mapPos),a},a.EngineView.prototype.addCustomObjectToLocation=function(b,c){return b.isMovableTo=a.existy(b.isMovableTo)?b.isMovableTo:!0,b.columnSpan=b.columnSpan||1,b.rowSpan=b.rowSpan||1,this.addObjectToLocation(b,c)},a.EngineView.prototype.removeObjectFromLocation=function(a,b){b=b||a.mapPos,this.objContainer.removeChild(a),this.removeObjRefFromLocation(a,b)},a.EngineView.prototype.focusMapToObject=function(a){this.focusMapToLocation(a.mapPos.c+(a.columnSpan-1)/2,a.mapPos.r-(a.rowSpan-1)/2,0)},a.EngineView.prototype.focusMapToLocation=function(a,b,c){this.zoomTo(c,!1),this.centralizeToLocation(a,b)},a.EngineView.prototype.centralizeToObject=function(a){this.centralizeToLocation(a.mapPos.c,a.mapPos.r)},a.EngineView.prototype.centralizeToLocation=function(a,b,c){this.currentFocusLocation={c:a,r:b};var d=this.externalCenter.x+(this.mapVisualWidthScaled>>1)-this.getTilePosXFor(b,a)*this.currentScale,e=this.externalCenter.y-this.getTilePosYFor(b,a)*this.currentScale;this.centralizeToPoint(d,e,c)},a.EngineView.prototype.centralizeToCurrentFocusLocation=function(a){this.centralizeToLocation(this.currentFocusLocation.c,this.currentFocusLocation.r,a)},a.EngineView.prototype.centralizeToCurrentExternalCenter=function(a){this.externalCenter&&(this.currentFocusLocation={c:this.mapSizeC>>1,r:this.mapSizeR>>1},this.centralizeToPoint(this.externalCenter.x,this.externalCenter.y,a))},a.EngineView.prototype.centralizeToPoint=function(b,c,d){this.tileArray&&(b-=this.mapVisualWidthScaled>>1,a.existy(d)&&d||!a.existy(d)&&this.config.instantCameraRelocation?(this.mapContainer.position.x=b,this.mapContainer.position.y=c):this.moveEngine.addTween(this.mapContainer.position,.5,{x:b,y:c},0,"easeInOut",!0))},a.EngineView.prototype.setZoomParameters=function(b,c,d,e,f){this.config.minScale=a.existy(b)?b:.5,this.config.maxScale=a.existy(c)?c:1.5,this.config.minZoom=-1,this.config.maxZoom=1,this.config.zoomIncrement=a.existy(d)?1>=d?0:2/(d-1):.5,this.config.initialZoomLevel=a.existy(e)?e:0,this.config.instantCameraZoom=a.existy(f)?f:!1},a.EngineView.prototype.setScale=function(b,c){b<this.config.minScale?b=this.config.minScale:b>this.config.maxScale&&(b=this.config.maxScale),this.currentScale=b,this.mapVisualWidthScaled=this.mapVisualWidthReal*this.currentScale,this.mapVisualHeightScaled=this.mapVisualHeightReal*this.currentScale,a.existy(c)&&c||!a.existy(c)&&this.config.instantCameraZoom?this.mapContainer.scale.set(this.currentScale):this.moveEngine.addTween(this.mapContainer.scale,.5,{x:this.currentScale,y:this.currentScale},0,"easeInOut",!0)},a.EngineView.prototype.zoomTo=function(b,c){b=b||0;var d=a.mathMap(b,this.config.minZoom,this.config.maxZoom,this.config.minScale,this.config.maxScale,!0);d=Math.round(10*d)/10,this.currentZoom=a.mathMap(d,this.config.minScale,this.config.maxScale,this.config.minZoom,this.config.maxZoom,!0),this.externalCenter=this.externalCenter?this.externalCenter:{x:this.mapVisualWidthScaled>>1,y:0};var e={x:this.mapContainer.position.x+(this.mapVisualWidthScaled>>1)-this.externalCenter.x,y:this.mapContainer.position.y-this.externalCenter.y},f=this.currentScale;this.setScale(d,c);var g=this.currentScale/f;this.centralizeToPoint(this.externalCenter.x+e.x*g,this.externalCenter.y+e.y*g,a.existy(c)&&c||!a.existy(c)&&this.config.instantCameraZoom)},a.EngineView.prototype.zoomOut=function(a){this.zoomTo(this.currentZoom-this.config.zoomIncrement,a)},a.EngineView.prototype.zoomIn=function(a){this.zoomTo(this.currentZoom+this.config.zoomIncrement,a)},a.EngineView.prototype.getCurrentControllable=function(){return this.currentControllable},a.EngineView.prototype.setCurrentControllable=function(a){this.currentControllable=a},a.EngineView.prototype.addObjRefToLocation=function(a,b){var c,d;for(c=b.c;c<b.c+a.columnSpan;c++)for(d=b.r;d>b.r-a.rowSpan;d--)this.addObjRefToSingleLocation(a,{c:c,r:d})},a.EngineView.prototype.addObjRefToSingleLocation=function(a,b){this.objArray[b.r][b.c]||(this.objArray[b.r][b.c]=[]);var c=this.objArray[b.r][b.c].indexOf(a);
0>c&&this.objArray[b.r][b.c].push(a),a.isMovableTo||this.pathFinding.setDynamicCell(b.c,b.r,0)},a.EngineView.prototype.removeObjRefFromLocation=function(a,b){var c,d;for(c=b.c;c<b.c+a.columnSpan;c++)for(d=b.r;d>b.r-a.rowSpan;d--)this.removeObjRefFromSingleLocation(a,{c:c,r:d})},a.EngineView.prototype.removeObjRefFromSingleLocation=function(a,b){if(this.objArray[b.r][b.c]){var c=this.objArray[b.r][b.c].indexOf(a);if(c>-1&&this.objArray[b.r][b.c].splice(c,1),0===this.objArray[b.r][b.c].length)this.pathFinding.setDynamicCell(b.c,b.r,1),this.objArray[b.r][b.c]=null;else for(var d=this.objArray[b.r][b.c],e=d.length,f=0;e>f;f++){if(!d[f].isMovableTo){this.pathFinding.setDynamicCell(b.c,b.r,0);break}f===e-1&&this.pathFinding.setDynamicCell(b.c,b.r,1)}}},a.EngineView.prototype.removeAllObjectRefsFromLocation=function(a){this.objArray[a.r][a.c]&&(this.pathFinding.setDynamicCell(a.c,a.r,1),this.objArray[a.r][a.c]=null)},a.EngineView.prototype.changeObjAlphasInLocation=function(a,b){var c=this.objArray[b.r][b.c];if(c)for(var d=c.length,e=0;d>e;e++)c[e].isFloorObject||c[e].noTransparency||(c[e].alpha=a)},a.EngineView.prototype.arrangeObjLocation=function(a,b){this.removeObjRefFromLocation(a,a.mapPos),this.addObjRefToLocation(a,b),a.mapPos={c:b.c,r:b.r}},a.EngineView.prototype.arrangeObjTransperancies=function(a,b,c){this.config.changeTransperancies&&(this.currentControllable===a&&(b.c>0&&this.changeObjAlphasInLocation(1,{c:b.c-1,r:b.r}),b.c>0&&b.r<this.mapSizeR-1&&this.changeObjAlphasInLocation(1,{c:b.c-1,r:b.r+1}),b.r<this.mapSizeR-1&&this.changeObjAlphasInLocation(1,{c:b.c,r:b.r+1}),c.c>0&&this.changeObjAlphasInLocation(.7,{c:c.c-1,r:c.r}),c.c>0&&c.r<this.mapSizeR-1&&this.changeObjAlphasInLocation(.7,{c:c.c-1,r:c.r+1}),c.r<this.mapSizeR-1&&this.changeObjAlphasInLocation(.7,{c:c.c,r:c.r+1})),a.alpha=1)},a.EngineView.prototype.arrangeDepthsFromLocation=function(a){var b,c,d,e;for(c=a.r;c<this.mapSizeR;c++)for(d=a.c;d>=0;d--)if(b=this.objArray[c][d])for(e=0;e<b.length;e++)b[e].isFloorObject||this.objContainer.addChild(b[e])},a.EngineView.prototype.arrangePathHighlight=function(a,b){var c,d,e;if(a)for(c=0;c<a.length;c++)e=a[c],b&&-1!==b.indexOf(e)||(d=this.tileArray[e.mapPos.r][e.mapPos.c],d.setHighlighted(!1,!this.config.tileHighlightAnimated));if(b)for(c=0;c<b.length;c++)e=b[c],a&&-1!==a.indexOf(e)||(d=this.tileArray[e.mapPos.r][e.mapPos.c],d.setHighlighted(!0,!this.config.tileHighlightAnimated))},a.EngineView.prototype.stopObject=function(a){a.currentPath=null,a.currentTarget=null,a.currentTargetTile=null,this.moveEngine.removeMovable(a)},a.EngineView.prototype.moveObjThrough=function(a,b,c){if(this.config.instantObjectRelocation){var d=this.tileArray[b[0].mapPos.r][b[0].mapPos.c];a.position.x=d.position.x,a.position.y=d.position.y+this.TILE_HALF_H,this.arrangeObjTransperancies(a,a.mapPos,d.mapPos),this.arrangeObjLocation(a,d.mapPos),this.arrangeDepthsFromLocation(d.mapPos)}else this.config.highlightPath&&this.currentControllable===a&&this.arrangePathHighlight(a.currentPath,b),a.currentTarget&&this.stopObject(a),this.moveEngine.prepareForMove(a,b,c),a.currentTargetTile=a.currentPath[a.currentPathStep],this.onObjMoveStepBegin(a,a.currentPath[a.currentPathStep].mapPos)},a.EngineView.prototype.onObjMoveStepBegin=function(b,c){return b.currentDirection=a.getDirBetween(b.mapPos.r,b.mapPos.c,c.r,c.c),b.changeVisualToDirection(b.currentDirection,!0),this.pathFinding.isCellFilled(c.c,c.r)?(this.moveEngine.removeMovable(b),this.checkAndMoveObjectToLocation(b,b.currentPath[0].mapPos),!1):(this.moveEngine.setMoveParameters(b,c),this.moveEngine.addMovable(b),!0)},a.EngineView.prototype.onObjMoveStepEnd=function(a){a.currentPathStep--,a.currentTarget=null,a.currentTargetTile=null;var b=0>a.currentPathStep;if(this.moveEngine.removeMovable(a),b?a.changeVisualToDirection(a.currentDirection,!1):this.config.checkPathOnEachTile?this.checkAndMoveObjectToLocation(a,a.currentPath[0].mapPos):(a.currentPath.splice(a.currentPath.length-1,1),this.moveObjThrough(a,a.currentPath)),this.currentControllable===a){var c=this.tileArray[a.mapPos.r][a.mapPos.c];c.setHighlighted(!1,!this.config.tileHighlightAnimated)}b&&this.config.objectReachedDestinationCallback&&this.config.objectReachedDestinationCallback(a)},a.EngineView.prototype.checkForFollowCharacter=function(a){if(this.config.followCharacter&&this.currentControllable===a){this.currentFocusLocation={c:a.mapPos.c,r:a.mapPos.r};var b=this.externalCenter.x-a.position.x*this.currentScale,c=this.externalCenter.y-a.position.y*this.currentScale;this.moveEngine.addTween(this.mapContainer.position,.1,{x:b,y:c},0,"easeOut",!0)}},a.EngineView.prototype.checkForTileChange=function(b){this.config.objectUpdateCallback&&this.config.objectUpdateCallback(b);for(var c={x:b.position.x,y:b.position.y-this.TILE_HALF_H},d=this.tileArray[b.currentTargetTile.mapPos.r][b.currentTargetTile.mapPos.c],e=[],f=0;f<d.vertices.length;f++)e[f]=[d.vertices[f][0]+d.position.x,d.vertices[f][1]+d.position.y];if((b.currentTargetTile.mapPos.r!==b.mapPos.r||b.currentTargetTile.mapPos.c!==b.mapPos.c)&&a.isInPolygon(c,e)){this.arrangeObjTransperancies(b,b.mapPos,b.currentTargetTile.mapPos),this.arrangeObjLocation(b,b.currentTargetTile.mapPos),this.arrangeDepthsFromLocation(b.mapPos);var g=this.getObjectsAtLocation(b.currentTargetTile.mapPos);g&&g.length>1&&this.config.otherObjectsOnTheNextTileCallback&&this.config.otherObjectsOnTheNextTileCallback(b,g)}},a.EngineView.prototype.getPath=function(a,b){if(this.pathFinding)return this.pathFinding.solve(a.c,a.r,b.c,b.r);throw new Error("Path finding hasn't been initialized yet!")},a.EngineView.prototype.checkAndMoveObjectToTile=function(a,b,c){return b.isMovableTo?this.checkAndMoveObjectToLocation(a,b.mapPos,c):!1},a.EngineView.prototype.checkAndMoveObjectToLocation=function(a,b,c){var d=this.getPath(a.mapPos,b);return d?(this.moveObjThrough(a,d,c),d.length):!1},a.EngineView.prototype.moveCurrentControllableToLocation=function(a,b){if(!this.currentControllable)throw new Error("TRAVISO: currentControllable is not defined!");return this.checkAndMoveObjectToLocation(this.currentControllable,a,b)},a.EngineView.prototype.moveCurrentControllableToObj=function(a,b){if(!this.currentControllable)throw new Error("TRAVISO: currentControllable is not defined!");if(a.currentInteractionOffset){var c={c:a.mapPos.c+a.currentInteractionOffset.c,r:a.mapPos.r+a.currentInteractionOffset.r};if(this.checkAndMoveObjectToLocation(this.currentControllable,c,b))return!0}for(var d,e,f,g,h=this.pathFinding.getAdjacentOpenCells(a.mapPos.c,a.mapPos.r,a.columnSpan,a.rowSpan),i=3e3,j=0;j<h.length;j++)if(d=this.tileArray[h[j].mapPos.r][h[j].mapPos.c]){if(d.mapPos.c===this.currentControllable.mapPos.c&&d.mapPos.r===this.currentControllable.mapPos.r)return this.arrangePathHighlight(this.currentControllable.currentPath),this.stopObject(this.currentControllable),g=this.config.instantObjectRelocation,this.config.instantObjectRelocation=!0,this.moveObjThrough(this.currentControllable,[d]),this.config.instantObjectRelocation=g,this.currentControllable.changeVisualToDirection(this.currentControllable.currentDirection,!1),this.config.objectReachedDestinationCallback&&this.config.objectReachedDestinationCallback(this.currentControllable),!0;e=this.getPath(this.currentControllable.mapPos,d.mapPos),e&&e.length<i&&(i=e.length,f=e)}return f?(this.moveObjThrough(this.currentControllable,f,b),!0):!1},a.EngineView.prototype.getTileFromLocalPos=function(b){var c=null;if(a.isInPolygon(b,this.mapVertices)){var d,e,f,g,h=this.TILE_HALF_W/2,i=3e3;for(e=0;e<this.mapSizeR;e++)for(f=0;f<this.mapSizeC&&(d=this.tileArray[e][f],!(d&&(g=a.getDist(b,d.position),i>g&&(i=g,c=d,h>g))));f++);}return c},a.EngineView.prototype.checkForTileClick=function(a){var b=this.mapContainer.toLocal(a.global),c=this.getTileFromLocalPos(b);if(c){var d=this.objArray[c.mapPos.r][c.mapPos.c];if(d)for(var e=0;e<d.length;e++){if(d[e].isInteractive){this.config.objectSelectCallback&&this.config.objectSelectCallback(d[e]);break}if(d[e].isMovableTo&&(this.config.dontAutoMoveToTile||!this.currentControllable||this.checkAndMoveObjectToTile(this.currentControllable,c))){this.config.highlightTargetTile&&c.setHighlighted(!0,!this.config.tileHighlightAnimated),this.config.tileSelectCallback&&this.config.tileSelectCallback(c.mapPos.r,c.mapPos.c);break}}else(this.config.dontAutoMoveToTile||!this.currentControllable||this.checkAndMoveObjectToTile(this.currentControllable,c))&&(this.config.highlightTargetTile&&c.setHighlighted(!0,!this.config.tileHighlightAnimated),this.config.tileSelectCallback&&this.config.tileSelectCallback(c.mapPos.r,c.mapPos.c))}},a.EngineView.prototype.enableInteraction=function(){this.mousedown=this.touchstart=this.onMouseDown.bind(this),this.mousemove=this.touchmove=this.onMouseMove.bind(this),this.mouseup=this.mouseupout=this.touchend=this.onMouseUp.bind(this),this.interactive=!0},a.EngineView.prototype.disableInteraction=function(){this.mousedown=this.touchstart=null,this.mousemove=this.touchmove=null,this.mouseup=this.mouseupout=this.touchend=null,this.interactive=!0,this.dragging=!1},a.EngineView.prototype.isInteractionInMask=function(a){return this.config.useMask&&(a.x<this.posFrame.x||a.y<this.posFrame.y||a.x>this.posFrame.x+this.posFrame.w||a.y>this.posFrame.y+this.posFrame.h)?!1:!0},a.EngineView.prototype.onMouseDown=function(a){var b=a.data.global;!this.dragging&&this.isInteractionInMask(b)&&(this.dragging=!0,this.dragInitStartingX=this.dragPrevStartingX=b.x,this.dragInitStartingY=this.dragPrevStartingY=b.y)},a.EngineView.prototype.onMouseMove=function(a){if(this.dragging&&this.config.mapDraggable){var b=a.data.global;this.mapContainer.position.x+=b.x-this.dragPrevStartingX,this.mapContainer.position.y+=b.y-this.dragPrevStartingY,this.dragPrevStartingX=b.x,this.dragPrevStartingY=b.y}},a.EngineView.prototype.onMouseUp=function(a){if(this.dragging){this.dragging=!1;var b=a.data.global.x-this.dragInitStartingX,c=a.data.global.y-this.dragInitStartingY;Math.abs(b)<5&&Math.abs(c)<5&&this.checkForTileClick(a.data)}},a.EngineView.prototype.repositionContent=function(b){a.trace("EngineView repositionContent"),b=b||this.posFrame||{x:0,y:0,w:800,h:600},this.position.x=b.x,this.position.y=b.y,this.externalCenter={x:b.w>>1,y:b.h>>1},this.centralizeToCurrentFocusLocation(!0),this.bg&&(this.bg.clear(),this.bg.beginFill(this.config.backgroundColor,1),this.bg.drawRect(0,0,b.w,b.h),this.bg.endFill()),this.mapMask&&this.mapContainer&&(this.mapMask.clear(),this.mapMask.beginFill("#000000"),this.mapMask.drawRect(0,0,b.w,b.h),this.mapMask.endFill(),this.mapContainer.mask=this.mapMask),this.posFrame=b},a.EngineView.prototype.destroy=function(){a.trace("EngineView destroy"),this.disableInteraction(),this.moveEngine.destroy(),this.moveEngine=null;var b,c,d,e;for(c=0;c<this.mapSizeR;c++)for(d=this.mapSizeC-1;d>=0;d--){if(b=this.tileArray[c][d],b&&b.destroy(),this.tileArray[c][d]=null,b=this.objArray[c][d])for(e=0;e<b.length;e++)b[e]&&b[e].destroy(),b[e]=null;this.objArray[c][d]=null}b=null,this.pathFinding.destroy(),this.pathFinding=null,this.currentControllable=null,this.tileArray=null,this.objArray=null,this.bg=null,this.groundContainer=null,this.objContainer=null,this.mapContainer&&(this.mapContainer.mask=null,this.removeChild(this.mapContainer),this.mapContainer=null),this.mapMask&&(this.removeChild(this.mapMask),this.mapMask=null),this.config=null,this.mapData.groundMapData=null,this.mapData.objectsMapData=null,this.mapData.objects=null,this.mapData.tiles=null,this.mapData=null},"function"==typeof define&&define.amd&&define([],function(){return{TRAVISO:a}}),"undefined"!=typeof exports&&(exports.TRAVISO=a),"undefined"!=typeof window?window.TRAVISO=a:"undefined"!=typeof global&&(global.TRAVISO=a)}).call(this);